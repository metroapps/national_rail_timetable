<?php
declare(strict_types = 1);

use Miklcct\NationalRailTimetable\Controllers\BoardQuery;
use Miklcct\NationalRailTimetable\Controllers\TimetableQuery;
use Miklcct\NationalRailTimetable\Models\Date;
use Miklcct\NationalRailTimetable\Models\DepartureBoard;
use Miklcct\NationalRailTimetable\Models\Location;
use Miklcct\NationalRailTimetable\Models\LocationWithCrs;
use Miklcct\NationalRailTimetable\Models\ServiceCallWithDestination;
use Miklcct\NationalRailTimetable\Models\Timetable;
use Miklcct\NationalRailTimetable\Views\ServiceView;
use Miklcct\NationalRailTimetable\Views\TimetableView;
use function Miklcct\NationalRailTimetable\get_all_tocs;
use function Miklcct\NationalRailTimetable\Views\show_time;
use function Miklcct\ThinPhpApp\Escaper\html;

/** @var TimetableView $this */
?>
<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="common.css" />
        <link rel="stylesheet" href="timetable.css" />
        <title><?= html($this->getTitle()) . ($this->query->permanentOnly ? ' (permanent timetable)' : '') ?></title>
    </head>
    <body>
        <?php
        if ($this->errorMessage !== null) {
            ?>
            <p class="error"><?= html($this->errorMessage) ?></p>
            <?php
        }
        ?>
        <form action="timetable.php" method="GET">
            <datalist id="stations">
                <?php
                foreach ($this->stations as $station) {
                    ?>
                    <option value="<?= html($station->getCrsCode()) ?>"><?= html($station->name) ?></option>
                    <?php
                }
                ?>
            </datalist>
            <p>
                Show
                <?php
                foreach (['departures', 'arrivals'] as $mode) {
                    ?>
                    <label>
                        <input type="radio" name="mode" value="<?= html($mode) ?>" <?= ($this->query->toArray()['mode'] ?? 'departures') === $mode ? 'checked = "checked"' : ''?>/>
                        <?= html($mode) ?>
                    </label>
                    <?php
                }
                ?>
                <label>at: <input autocomplete="off" list="stations" required="required" type="text" name="station" size="32" value="<?= html($this->query->toArray()['station'] ?? null)?>"/></label><br/>
                <label>on (leave empty for today)
                    <input type="date"
                           name="date"
                           value="<?= html($this->query->toArray()['date']) ?>"
                           min="<?= html((new DateTimeImmutable('-7 days'))->format('Y-m-d')) ?>"
                           max="<?= html((new DateTimeImmutable('+180 days'))->format('Y-m-d')) ?>"
                    />
                </label>
            </p>
            <p>
                <label>Show permanent timetable instead of actual timetable: <input type="checkbox" name="permanent_only" value="1" <?= !empty($this->query->toArray()['permanent_only']) ? 'checked="checked"' : '' ?>/></label><br/>
            </p>
            <p>
                <input type="submit" />
            </p>
        </form>
        <h1><?= html($this->getTitle()) ?></h1>
<?php
if ($this->query->permanentOnly) {
?>
        <p id="permanent_warning">Warning: Permanent timetable instead of actual timetable shown</p>
<?php
}
/** @var DepartureBoard $board */
foreach ($this->boards as $board) {
    $timetable = Timetable::generateFromBoard($board);
    $stations = $timetable->stations;
    $calls = $timetable->calls;

    $get_colspan = static function(array $array, int $i) {
        $call = $array[$i];
        $colspan = 0;
        while (
            isset($array[$i]) 
            && $array[$i]->uid === $call->uid
            && $array[$i]->timestamp == $call->timestamp
        ) {
            ++$colspan;
            ++$i;
        }
        return $colspan;
    };
    $via = $board->getDestinations(true);
    $destinations = $board->getDestinations();
?>
        <section>
            <h2>Trains
                <?= $this->query->arrivalMode && $destinations ? ' from ' . html(implode(', ', array_map(static fn(Location $location) => $location->getShortName(), $destinations))) : '' ?>
                <?= $via ? ' via ' . html(implode(', ', array_map(static fn(Location $location) => $location->getShortName(), $via))) : '' ?>
                <?= !$this->query->arrivalMode && $destinations ? ' towards ' . html(implode(', ', array_map(static fn(Location $location) => $location->getShortName(), $destinations))) : '' ?>
            </h2>
            <div class="container">
                <table>
                    <thead>
                        <tr>
                            <th class="station_column">TOC</th>
<?php
    $i = 0;
    while (isset($calls[0][$i])) {
        /** @var ServiceCallWithDestination $call */
        $call = $calls[0][$i];
        $colspan = $get_colspan($calls[0], $i);
        $i += $colspan;
?>
                            <th class="service" colspan=<?= $colspan ?>>
                                <abbr title="<?= html(get_all_tocs()[$call->toc]) ?>"><?= html($call->toc) ?></abbr>
                            </th>
<?php
    }
?>
                        </tr>
                        <tr>
                            <td class="station_column">Headcode</td>
<?php
    $i = 0;
    while (isset($calls[0][$i])) {
        /** @var ServiceCallWithDestination $call */
        $call = $calls[0][$i];
        $colspan = $get_colspan($calls[0], $i);
        $i += $colspan;
?>
                            <td colspan=<?= $colspan ?>><?= html($call->serviceProperty->headcode) ?></td>
<?php
    }
?>
                        </tr>
                        <tr>
                            <td class="station_column"><?= html($this->query->arrivalMode ? 'Origin' : 'Destination') ?></td>
<?php
    $i = 0;
    while (isset($calls[0][$i])) {
        /** @var ServiceCallWithDestination $call */
        $call = $calls[0][$i];
        foreach ($this->query->arrivalMode ? $call->origins : $call->destinations as $destination) {
            $destination_location = $destination->location;
            if (!$destination_location instanceof LocationWithCrs) {
                $destination_location = null;
            }
?>
                            <td><abbr title="<?=
                                html($destination_location?->getShortName()) ?>"><?= html($destination_location?->getCrsCode()) ?></abbr></td>
<?php
            ++$i;
        }
    }
?>
                        </tr>
                        <tr>
                            <td class="station_column">Facilities</td>
<?php
    $i = 0;
    while (isset($calls[0][$i])) {
        /** @var ServiceCallWithDestination $call */
        $call = $calls[0][$i];
        $colspan = $get_colspan($calls[0], $i);
        $i += $colspan;
?>
                            <td colspan=<?= $colspan ?>><?= $call->mode->showIcon() . $call->serviceProperty->showIcons() ?></td>
<?php
    }
?>
                        </tr>
                        <tr>
                            <td class="station_column">Platform</td>
<?php
    $i = 0;
    while (isset($calls[0][$i])) {
        /** @var ServiceCallWithDestination $call */
        $call = $calls[0][$i];
        $colspan = $get_colspan($calls[0], $i);
        $i += $colspan;
?>
                            <td colspan=<?= $colspan ?>><?= html($call->call->platform) ?></td>
<?php
    }
?>
                        </tr>
<?php
    foreach ($stations as $i => $station) {
        if ($i === 0 && $this->query->arrivalMode) {
?>
                    </thead>
                    <tfoot>
<?php
        } elseif ($i === 1) {
            if ($this->query->arrivalMode) {
?>
                    </tfoot>
<?php
            } else {
?>
                    </thead>
<?php
            }
?>
                    <tbody>
<?php
        }
?>
                        <tr class="<?= $i === 0 ? 'origin' : '' ?> <?= $i !== 0 && in_array($station->getCrsCode(), array_map(static fn(LocationWithCrs $location) => $location->getCrsCode(), $this->query->filter), true) ? 'destination' : '' ?>">
                            <td class="station_column">
<?php
        if ($i !== 0) {
?>
                                <a href="<?= html((new TimetableQuery($this->query->arrivalMode, $station, [], $this->query->date, $this->query->permanentOnly))->getUrl()) ?>">
<?php
        }
?>
                                <?= html($station->getShortName()) ?>
<?php
        if ($i !== 0) {
?>
                                </a>
<?php
        }
?>
                            </td>
<?php
        $j = 0;
        while (isset($calls[0][$j])) {
            if (!isset($calls[$i][$j])) {
                ++$j;
?>
                            <td></td>
<?php
            } else {
                $call = $calls[$i][$j];
                $colspan = $get_colspan($calls[$i], $j);
                $j += $colspan;
                $link = $i === 0
                    ? ServiceView::getServiceUrl($call->uid, $call->date, $this->query->permanentOnly)
                    : (new BoardQuery(
                        $this->query->arrivalMode
                        , $stations[$i]
                        , null
                        , Date::fromDateTimeInterface($call->timestamp->sub(new DateInterval($this->query->arrivalMode ? 'PT4H30M' : 'P0D')))
                        , $call->timestamp
                        , $call->toc
                        , $this->query->permanentOnly
                    ))->getUrl();
?>
                           <td colspan=<?= $colspan ?>><?= show_time($call->timestamp, $this->date, $link)?></td>
<?php
            }
        }
?>
                        </tr>
<?php
    }
?>
                    </tbody>
                </table>
            </div>
        </section>
<?php
}
?>
    </body>
</html>