<?php
declare(strict_types=1);

use Miklcct\NationalRailTimetable\Views\BoardFormView;
use Miklcct\NationalRailTimetable\Views\BoardView;
use Miklcct\NationalRailTimetable\Models\FixedLink;
use Miklcct\NationalRailTimetable\Enums\Activity;
use Miklcct\NationalRailTimetable\Enums\Mode;
use Miklcct\NationalRailTimetable\Models\Station;
use Miklcct\NationalRailTimetable\Models\Location;
use Miklcct\NationalRailTimetable\Models\ServiceCallWithDestination;
use Miklcct\NationalRailTimetable\Views\ServiceView;

use function Miklcct\NationalRailTimetable\get_all_tocs;
use function Miklcct\ThinPhpApp\Escaper\html;

/** @var BoardFormView $this */
?>
<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="board.css" />
        <title><?= html($this->getTitle()) ?></title>
    </head>
    <body>
    <form action="<?= html($this->boardUrl) ?>" method="GET">
            <datalist id="stations">
<?php
/** @var Location */
foreach ($this->stations as $station) {
?>
                <option value="<?= html($station->crsCode) ?>"><?= html($station->name) ?></option>
<?php
}
?>
            </datalist>
            <p>
                Show 
<?php
foreach (['departures', 'arrivals'] as $mode) {
?>
                <label>
                    <input type="radio" name="mode" value="<?= html($mode) ?>" <?= ($this->getFormData()['mode'] ?? 'departures') === $mode ? 'checked = "checked"' : ''?>/>
                    <?= html($mode) ?>
                </label>
<?php
}
?>
                <label>at: <input autocomplete="off" list="stations" required="required" type="text" name="station" size="32" value="<?= html($this->getFormData()['station'] ?? null)?>"/></label><br/>
                <label>only trains calling at (optional): <input autocomplete="off" list="stations" type="text" name="filter" size="32" value="<?= html($this->getFormData()['filter'] ?? null) ?>"/></label><br/>
                <label>from (leave empty for now) <input type="datetime-local" name="from" value="<?= html($this->getFormData()['from'] ?? null) ?>"/></label>
            </p>
            <p>
                <label>Show valid connections at: <input type="datetime-local" name="connecting_time" value="<?= html($this->getFormData()['connecting_time'] ?? null) ?>"/>
                from TOC: <select name="connecting_toc">
                    <option></option>
<?php
/** @var Location */
foreach (get_all_tocs() as $code => $name) {
?>
                    <option value="<?= html($code) ?>" <?= $code === ($this->getFormData()['connecting_toc'] ?? null) ? 'selected="selected"' : '' ?>><?= html($name) ?></option>
<?php
}
?>
                </select></label></br>
            </p>
            <p>
                <label>Show permanent timetable instead of actual timetable: <input type="checkbox" name="permanent_only" <?= !empty($this->getFormData()['permanent_only']) ? 'checked="checked"' : '' ?>/></label><br/>
            </p>
            <p>
                <input type="submit" />
            </p>
        </form>
<?php
if ($this instanceof BoardView) {
?>  
        <h1><?= html($this->getHeading()) ?></h1>
<?php
    if ($this->station instanceof Station) {
?>
        <p>Minimum connection time is <span class="time"><?= html($this->station->minimumConnectionTime . ($this->station->minimumConnectionTime === 1 ? ' minute' : ' minutes')) ?></span><?= $this->station->tocConnectionTimes === [] ? '.' : ', with the exception of the following:' ?></p>
<?php
        if ($this->station->tocConnectionTimes !== []) {
?>
        <table>
            <thead>
                <tr><th>From</th><th>To</th><th>Minutes</th></tr>
            </thead>
            <tbody>
<?php
            foreach ($this->station->tocConnectionTimes as $entry) {
?>
                <tr>
                    <td><?= $this->showToc($entry->arrivingToc) ?></td>
                    <td><?= $this->showToc($entry->departingToc) ?></td>
                    <td><?= html($entry->connectionTime) ?></td>
                </tr>
<?php
            }
?>
            </tbody>
        </table>
<?php
        }

        if (!empty($this->fixedLinks)) {
?>
        <table>
            <thead>
                <tr><th colspan="6">Fixed links as of <?= html($this->fixedLinkDepartureTime->format('Y-m-d H:i')) ?></th></tr>
                <tr><th>Transfer to</th><th>Mode</th><th>From</th><th>To</th><th>Minutes</th><th><?= $this->arrivalMode ? 'Departure' : 'Arrival' ?></th></tr>
            </thead>
            <tbody>
<?php
            /** @var FixedLink */
            foreach ($this->fixedLinks as $link) {
                $arrival_time = $link->getArrivalTime($this->fixedLinkDepartureTime, $this->arrivalMode);
?>
                <tr>
                    <td class="destination">
                        <a href="<?= html($this->getFixedLinkUrl($link)) ?>">
                            <?= html($link->destination->getShortName()) ?>
                        </a>
                    </td>
                    <td><?= html($link->mode) ?></td>
                    <td><?= html($link->startTime) ?></td>
                    <td><?= html($link->endTime) ?></td>
                    <td><?= html($link->transferTime) ?></td>
                    <td class="time"><?= html($arrival_time->format('H:i')) ?></td>
                </tr>
<?php
            }
?>
            </tbody>
        </table>
<?php
        }
    }
?>
        <table>
            <thead>
                <tr>
                    <th>Time</th>
                    <th></th>
                    <th>Pl.</th>
                    <th>TOC</th>
                    <th>Train no.</th>
                    <th><?= $this->arrivalMode ? 'Origin' : 'Destination' ?></th>
                    <th>Calling at</th>
                </tr>
            </thead>
            <tbody>
<?php
    $date = null;
    foreach ($this->arrivalMode ? array_reverse($this->board->calls, true) : $this->board->calls as $service_call) {
        $current_date = $service_call->timestamp->format('Y-m-d');
        if ($current_date !== $date) {
            $date = $current_date;
?>
                <tr>
                    <th colspan="7"><?= html($date) ?></th>
                </tr>
<?php
        }
        $destinations = $this->arrivalMode ? $service_call->origins : $service_call->destinations;
        $portions_count = count($destinations);
        $portion_uids = array_keys($destinations);
        $overtaken_portions = array_combine(
            $portion_uids
            , array_map(
                fn(string $uid) : bool => $this->destination !== null ? $this->board->isOvertaken($service_call, $this->destination->crsCode, $uid) : false
                , $portion_uids
            )
        );
?>
                <tr class="<?= !in_array(false, $overtaken_portions, true) ? 'overtaken' : '' ?>">
                    <td class="time" rowspan="<?= html($portions_count) ?>">
                        <a href="<?= html($this->getServiceLink($service_call)) ?>" class="<?= $this->connectingTime === null || !$this->station instanceof Station ? '' : ($service_call->isValidConnection($this->connectingTime, $this->connectingToc ?? null) ? 'valid_connection' : 'invalid_connection') ?>">
                            <?= html($service_call->timestamp->format('H:i')) . (in_array(Activity::REQUEST_STOP, $service_call->call->activities) ? '<abbr title="request stop">x</abbr>' : '') ?>
                       </a>    
                    </td>
                    <td rowspan="<?= html($portions_count) ?>"><?= $this->showFacilities($service_call) ?></td>
                    <td rowspan="<?= html($portions_count) ?>"><?= html($service_call->call->platform) ?></td>
                    <td rowspan="<?= html($portions_count) ?>"><?= $this->showToc($service_call->toc) ?></td>
                    <td rowspan="<?= html($portions_count) ?>"><a href="<?= html($this->getServiceLink($service_call)) ?>"><?= html(substr($service_call->serviceProperty->rsid, 0, 6)) ?></a></td>
<?php
        foreach ($portion_uids as $i => $uid) {
            if ($i > 0) {
?>
                </tr>
                <tr class="<?= !in_array(false, $overtaken_portions, true) ? 'overtaken' : '' ?>">
<?php
            }
?>
                    <td class="destination <?= $overtaken_portions[$uid] ? 'overtaken' : '' ?>"><?= html($destinations[$uid]->location->getShortName()) ?></td>
                    <td class="<?= $overtaken_portions[$uid] ? 'overtaken' : '' ?>"><?=                        
                        implode(
                            ', '
                            , array_map(
                                function(ServiceCallWithDestination $service_call): string { 
                                    $station = $service_call->call->location;
                                    $link = $this->getArrivalLink($service_call);
                                    return sprintf(
                                        $link === null ? '<span class="%2$s">%3$s (%4$s%5$s)</span>' : '<a href="%s" class="%s">%s (%s%s)</a>'
                                        , html($link)
                                        , $station->crsCode !== null && $station->crsCode === $this->destination?->crsCode ? 'destination' : ''
                                        , html($station->getShortName())
                                        , html($service_call->timestamp->format('H:i'))
                                        , in_array(Activity::REQUEST_STOP, $service_call->call->activities) ? '<abbr title="request stop">x</abbr>' : ''
                                    );
                                }
                                , array_filter(
                                    $this->arrivalMode ? $service_call->precedingCalls : $service_call->subsequentCalls
                                    , fn(ServiceCallWithDestination $service_call) : bool =>
                                        in_array($uid, array_keys($this->arrivalMode ? $service_call->origins : $service_call->destinations), true)
                                )
                            )
                        )
                    ?></td>
<?php
        }
?>
                </tr>
<?php
    }
?>
            </tbody>
        </table>
<?php
}
?>
    </body>
</html>